<script>
  try { Telegram.WebApp.ready(); Telegram.WebApp.expand(); } catch (e) {}

  const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: 'https://kiomamaeoka.github.io/maeoka-miniapp-demo/tonconnect-manifest.json',
    buttonRootId: 'ton-connect'
  });

  const statusEl = document.getElementById('status');
  const mockBtn  = document.getElementById('mock');
  const out      = document.getElementById('out');

  function short(a){ return a ? a.slice(0,6)+'…'+a.slice(-4) : ''; }

  function refresh(){
    const acc = tonConnectUI.account;
    if (acc && acc.address){
      statusEl.textContent = 'Status: conectado ('+ short(acc.address) +')';
      mockBtn.disabled = false;
    } else {
      statusEl.textContent = 'Status: desconectado';
      mockBtn.disabled = true;
      out.textContent = '';
    }
  }

  tonConnectUI.onStatusChange(refresh);
  refresh();

  document.getElementById('mock').onclick = () => {
    const acc = tonConnectUI.account;
    if (!acc){ alert('Conecte a carteira primeiro.'); return; }
    const data = {
      id: 'NFT-' + Math.random().toString(36).slice(2,8).toUpperCase(),
      owner: acc.address,
      project: document.getElementById('project').value || 'Residencial DEMO',
      ownership_percentage: parseFloat(document.getElementById('percent').value || '0'),
      initial_investment_brl: parseFloat(document.getElementById('amount').value || '0'),
      created_at: new Date().toISOString(),
      note: 'PREVIEW LOCAL — não gravado na blockchain'
    };
    out.textContent = JSON.stringify(data, null, 2);
  };
</script>
